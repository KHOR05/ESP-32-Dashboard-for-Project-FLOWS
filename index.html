<!DOCTYPE html>
<html lang="en">  
<head>
  <meta charset="UTF-8">   
  <title>FLOWS IoT Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #46ccea; }
    .card { background: rgb(249, 249, 249); padding: 20px; margin: 40px auto; width: 520px; border-radius: 12px; box-shadow: 0px 4px 10px rgba(0,0,0,0.1); }
    h2 { margin: 0; }
    #charts { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
    canvas { background: #f7f7f7; border-radius: 10px; padding: 10px; }
    #status { font-weight: bold; font-size: 1em; }
    .ok { color: green; }
    .leak { color: red; }
    #serverStatus { font-weight: bold; font-size: 1em; }
    .online { color: green; }
    .offline { color: red; }
  </style>
</head>
<body>

  <h1>FLOWS (Fire Line Overflow & Water Leak Sensor)</h1>
  <h1>with IoT by using ESP32</h1>

  <div class="card">
    <h2>Water Flow Rate: <span id="flow">--</span> L/min</h2>
    <h2>Water Pressure: <span id="pressure">--</span> Psi</h2>
    <h2>System Status: <span id="status">--</span></h2>
    <h2>Server Connection: <span id="serverStatus" class="offline">ðŸ”´ Disconnected</span></h2>
  </div>

  <div id="charts">
    <canvas id="flowChart" width="400" height="200"></canvas>
    <canvas id="pressureChart" width="400" height="200"></canvas>
  </div>

<script>
  // --- MQTT.js Setup ---
  const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

  const serverStatusEl = document.getElementById("serverStatus");

  client.on("connect", () => {
    console.log("âœ… Connected to HiveMQ broker via WebSocket");
    serverStatusEl.innerText = "ðŸŸ¢ Online";
    serverStatusEl.className = "online";

    client.subscribe("esp32/flow");
    client.subscribe("esp32/pressure");
    client.subscribe("esp32/status");
  });

  client.on("error", () => {
    console.log("âŒ Error connecting to broker");
    serverStatusEl.innerText = "ðŸ”´ Disconnected";
    serverStatusEl.className = "offline";
  });

  client.on("close", () => {
    console.log("âš ï¸ Connection closed");
    serverStatusEl.innerText = "ðŸ”´ Disconnected";
    serverStatusEl.className = "offline";
  });

  client.on("offline", () => {
    console.log("âš ï¸ Broker offline");
    serverStatusEl.innerText = "ðŸ”´ Disconnected";
    serverStatusEl.className = "offline";
  });

  client.on("message", (topic, message) => {
    const value = message.toString();
    console.log("ðŸ“© " + topic + ": " + value);

    if (topic === "esp32/flow") {
      document.getElementById("flow").innerText = value;
      addData(flowChart, parseFloat(value));
      saveHistory("flowHistory", flowChart);
    }
    if (topic === "esp32/pressure") {
      document.getElementById("pressure").innerText = value;
      addData(pressureChart, parseFloat(value));
      saveHistory("pressureHistory", pressureChart);
    }
    if (topic === "esp32/status") {
      const statusEl = document.getElementById("status");
      if (value === "LEAK") {
        statusEl.innerText = "ðŸš¨ Water Leak Detected!";
        statusEl.className = "leak";
      } else {
        statusEl.innerText = "âœ… No Water Leak Detected";
        statusEl.className = "ok";
      }
      localStorage.setItem("status", value);
    }
  });

  // --- Chart.js Setup ---
  function createChart(ctx, label, color) {
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: label,
          data: [],
          borderColor: color,
          fill: false,
        }]
      },
      options: {
        responsive: true,
        animation: false,
        scales: { x: { display: false }, y: { beginAtZero: true } }
      }
    });
  }

  const flowChart = createChart(document.getElementById("flowChart"), "Flow (L/min)", "blue");
  const pressureChart = createChart(document.getElementById("pressureChart"), "Pressure (psi)", "red");

  function addData(chart, value) {
    chart.data.labels.push(new Date().toLocaleTimeString()); // timestamp label
    chart.data.datasets[0].data.push(value);
    if (chart.data.labels.length > 20) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }

  // --- Save chart history to localStorage ---
  function saveHistory(key, chart) {
    const data = {
      labels: chart.data.labels,
      values: chart.data.datasets[0].data
    };
    localStorage.setItem(key, JSON.stringify(data));
  }

  // --- Load chart history from localStorage ---
  function loadHistory(key, chart) {
    const saved = localStorage.getItem(key);
    if (saved) {
      const data = JSON.parse(saved);
      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.values;
      chart.update();
    }
  }

  // --- Load last values & history when refreshing ---
  window.onload = () => {
    // restore history
    loadHistory("flowHistory", flowChart);
    loadHistory("pressureHistory", pressureChart);

    // restore latest values
    if (localStorage.getItem("flow")) {
      document.getElementById("flow").innerText = localStorage.getItem("flow");
    }
    if (localStorage.getItem("pressure")) {
      document.getElementById("pressure").innerText = localStorage.getItem("pressure");
    }
    if (localStorage.getItem("status")) {
      const statusEl = document.getElementById("status");
      if (localStorage.getItem("status") === "LEAK") {
        statusEl.innerText = "ðŸš¨ Water Leak Detected!";
        statusEl.className = "leak";
      } else {
        statusEl.innerText = "âœ… No Water Leak Detected";
        statusEl.className = "ok";
      }
    }
  };
</script>

</body>
</html>
