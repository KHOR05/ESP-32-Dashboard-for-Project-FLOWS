<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESP32 IoT Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f5f5f5; }
    .card { background: white; padding: 20px; margin: 20px auto; width: 400px; border-radius: 12px; box-shadow: 0px 4px 10px rgba(0,0,0,0.1); }
    h2 { margin: 0; }
    #charts { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
    canvas { background: #fff; border-radius: 10px; padding: 10px; }
  </style>
</head>
<body>

  <h1>ðŸš° ESP32 IoT Dashboard</h1>

  <div class="card">
    <h2>Flow: <span id="flow">--</span> L/min</h2>
    <h2>Pressure: <span id="pressure">--</span></h2>
    <h2>Status: <span id="status">--</span></h2>
  </div>

  <div id="charts">
    <canvas id="flowChart" width="400" height="200"></canvas>
    <canvas id="pressureChart" width="400" height="200"></canvas>
  </div>

  <script>
    // --- MQTT.js Setup ---
    const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

    client.on("connect", () => {
      console.log("âœ… Connected to HiveMQ broker via WebSocket");
      client.subscribe("esp32/flow");
      client.subscribe("esp32/pressure");
      client.subscribe("esp32/status");
    });

    client.on("message", (topic, message) => {
      const value = message.toString();
      console.log("ðŸ“© " + topic + ": " + value);

      if (topic === "esp32/flow") {
        document.getElementById("flow").innerText = value;
        addData(flowChart, value);
      }
      if (topic === "esp32/pressure") {
        document.getElementById("pressure").innerText = value;
        addData(pressureChart, value);
      }
      if (topic === "esp32/status") {
        document.getElementById("status").innerText = value;
      }
    });

    // --- Chart.js Setup ---
    function createChart(ctx, label, color) {
      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: label,
            data: [],
            borderColor: color,
            fill: false,
          }]
        },
        options: {
          responsive: true,
          animation: false,
          scales: { x: { display: false }, y: { beginAtZero: true } }
        }
      });
    }

    const flowChart = createChart(document.getElementById("flowChart"), "Flow (L/min)", "blue");
    const pressureChart = createChart(document.getElementById("pressureChart"), "Pressure", "red");

    function addData(chart, value) {
      chart.data.labels.push("");
      chart.data.datasets[0].data.push(parseFloat(value));
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }
  </script>
</body>
</html>
